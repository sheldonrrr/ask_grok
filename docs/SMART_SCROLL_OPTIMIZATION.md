# 智能滚动优化 (Smart Scroll Optimization)

## 问题描述

在流式响应过程中存在两个用户体验问题：

1. **无法向上查看**：响应区域持续自动滚动到底部，用户无法在AI生成时向上查看之前的内容
2. **无法向下查看**：当用户向上滚动后又想向下查看时，流式更新会不断刷新导致无法顺畅滚动

## 解决方案

实现**智能滚动机制**，包含三个核心特性：

### 1. 底部检测
- 只有当用户位于底部时（误差5像素内），才自动跟随最新内容
- 如果用户不在底部，保持当前滚动位置

### 2. 用户滚动检测
- 监听滚动条 `valueChanged` 信号
- 当用户离开底部区域时，标记 `_user_is_scrolling = True`
- 暂停所有自动滚动行为，让用户自由浏览

### 3. 自动恢复机制
- 当用户滚动回底部（5像素内）时，立即恢复自动滚动
- 当用户停止滚动2秒后，如果接近底部（100像素内），自动恢复

## 技术实现

### 核心变量
```python
self._user_is_scrolling = False      # 用户是否正在主动滚动
self._last_scroll_value = 0          # 上次滚动位置
self._scroll_resume_timer = None     # 恢复自动滚动的定时器
```

### 关键方法

1. **`_on_scroll_value_changed(value)`**
   - 检测用户滚动行为
   - 判断是否离开/回到底部
   - 启动2秒恢复定时器

2. **`_resume_auto_scroll()`**
   - 用户停止滚动2秒后触发
   - 检查是否接近底部（100像素内）
   - 自动恢复滚动跟随

3. **`_set_html_response(html)`**
   - 更新HTML内容前检查用户状态
   - 只在 `was_at_bottom and not _user_is_scrolling` 时自动滚动

## 用户体验

### 场景1：正常跟随（默认行为）
- 用户在底部 → 自动滚动到最新内容 ✅

### 场景2：向上查看历史
- 用户向上滚动 → 检测到离开底部 → 暂停自动滚动 ✅
- 用户可以自由查看之前的内容

### 场景3：向下查看新内容
- 用户向下滚动 → 仍处于非底部状态 → 继续暂停自动滚动 ✅
- 用户可以顺畅滚动，不会被流式更新打断

### 场景4：回到底部
- 用户滚动到底部 → 立即恢复自动滚动 ✅
- 或用户停止滚动2秒 + 接近底部 → 自动恢复 ✅

## 修改文件

- `response_handler.py`
  - `__init__()`: 添加智能滚动状态变量
  - `setup()`: 连接滚动条信号
  - `_on_scroll_value_changed()`: 新增，检测用户滚动
  - `_resume_auto_scroll()`: 新增，自动恢复机制
  - `_set_html_response()`: 修改，添加用户滚动状态判断

## 开发时间

- 约30分钟

## 状态

✅ 已完成，待测试
